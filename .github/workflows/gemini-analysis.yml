name: E-Shop AI Analysis & Documentation

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]
    # Only run for PRs from the same repository (not forks)
    types: [opened, synchronize, reopened]
  workflow_dispatch: # Manual trigger

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  gemini-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”‘ Check API Key
      id: check-key
      run: |
        if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ GEMINI_API_KEY not found, running in demo mode"
        else
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… GEMINI_API_KEY found, proceeding with AI analysis"
        fi
        
    - name: ğŸ›ï¸ Checkout Repository
    - name: ğŸ›ï¸ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        # Install main project dependencies
        npm install
        
        # Check if gemini-cli directory exists and has package.json
        if [ -d "tools/gemini-cli" ] && [ -f "tools/gemini-cli/package.json" ]; then
          cd tools/gemini-cli
          npm install
        else
          echo "âš ï¸ Gemini CLI package.json not found, skipping CLI dependencies"
        fi
        
    - name: ğŸ”§ Setup Environment
      run: |
        # Create .env file with conditional API key
        if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > tools/gemini-cli/.env
          echo "CATALOG_API_URL=http://localhost:8000" >> tools/gemini-cli/.env
          echo "BASKET_API_URL=http://localhost:8001" >> tools/gemini-cli/.env
          echo "ORDERING_API_URL=http://localhost:8002" >> tools/gemini-cli/.env
          echo "DISCOUNT_API_URL=http://localhost:8003" >> tools/gemini-cli/.env
          echo "âœ… Environment configured with API key"
        else
          echo "âš ï¸ GEMINI_API_KEY secret not found. Running in demo mode."
          echo "ğŸ“ Creating demo .env file"
          echo "GEMINI_API_KEY=demo_key_replace_with_real_key" > tools/gemini-cli/.env
          echo "CATALOG_API_URL=http://localhost:8000" >> tools/gemini-cli/.env
          echo "BASKET_API_URL=http://localhost:8001" >> tools/gemini-cli/.env
          echo "ORDERING_API_URL=http://localhost:8002" >> tools/gemini-cli/.env
          echo "DISCOUNT_API_URL=http://localhost:8003" >> tools/gemini-cli/.env
          echo "ğŸ”‘ For maintainers: Add GEMINI_API_KEY to repository secrets"
        fi
        
    - name: ğŸ” Validate Setup
      run: |
        echo "ğŸ” Validating GitHub Actions setup..."
        
        # Check if validation script exists
        if [ -f "tools/validate-setup.js" ]; then
          npm run validate-setup || echo "âš ï¸ Setup validation failed"
        else
          echo "âš ï¸ Validation script not found"
        fi
        
        # Check if CLI commands exist
        if [ -f "tools/gemini-cli/gemini-cli.js" ]; then
          echo "âœ… Gemini CLI found"
          npm run cli:help || echo "âš ï¸ CLI help command failed"
        else
          echo "âŒ Gemini CLI not found"
        fi
        
    - name: ğŸ” Run Project Analysis
      run: npm run cli:analyze
      continue-on-error: true
      
    - name: ğŸ“ Generate Service Documentation
      run: |
        npm run cli:docs Catalog || echo "Catalog docs generation failed"
        npm run cli:docs Basket || echo "Basket docs generation failed"
        npm run cli:docs Ordering || echo "Ordering docs generation failed"
        npm run cli:docs Discount || echo "Discount docs generation failed"
      continue-on-error: true
        
    - name: ğŸ§ª Generate Test Suggestions
      run: |
        npm run cli:tests Catalog > test-suggestions-catalog.md || echo "Catalog test suggestions failed"
        npm run cli:tests Basket > test-suggestions-basket.md || echo "Basket test suggestions failed"
        npm run cli:tests Ordering > test-suggestions-ordering.md || echo "Ordering test suggestions failed"
        npm run cli:tests Discount > test-suggestions-discount.md || echo "Discount test suggestions failed"
      continue-on-error: true
        
    - name: ğŸ³ Docker Optimization
      run: npm run cli:docker > docker-optimization.md || echo "Docker optimization failed"
      continue-on-error: true
      
    - name: ğŸ“¤ Upload Generated Documentation
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gemini-generated-docs-${{ github.run_number }}
        path: |
          **/API-Documentation.md
          test-suggestions-*.md
          docker-optimization.md
        retention-days: 30
        
    - name: ğŸ’¬ Comment on PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## ğŸ¤– AI Analysis Results\n\n';
          
          // Check if documentation was generated
          const services = ['Catalog', 'Basket', 'Ordering', 'Discount'];
          for (const service of services) {
            const docPath = `${service}/API-Documentation.md`;
            if (fs.existsSync(docPath)) {
              comment += `âœ… Documentation generated for ${service} service\n`;
            } else {
              comment += `âŒ Documentation generation failed for ${service} service\n`;
            }
          }
          
          comment += '\nğŸ“ **Generated Files:**\n';
          comment += '- API Documentation for each service\n';
          comment += '- Test suggestions\n';
          comment += '- Docker optimization recommendations\n\n';
          comment += 'ğŸ“ Check the **Artifacts** section to download generated documentation.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
